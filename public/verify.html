<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const statusIcon = document.getElementById('status-icon');
    const statusTitle = document.getElementById('status-title');
    const statusMessage = document.getElementById('status-message');
    const hintText = document.getElementById('hint-text');
    const retryButton = document.getElementById('retryButton');
    
    retryButton.addEventListener('click', runVerification);

    async function runVerification() {
        // Reset UI to initial loading state
        statusIcon.innerHTML = '<div class="spinner"></div>';
        statusTitle.innerText = 'Verification';
        statusMessage.innerText = 'Please wait while we verify your eligibility...';
        hintText.innerText = 'This should only take a moment.';
        statusMessage.style.color = 'inherit';
        retryButton.style.display = 'none';

        let verificationPayload = {}; // Declare outside try block

        try {
            // Get user IP/location info
            const geoResponse = await fetch('https://ipapi.co/json/');
            const geoData = await geoResponse.json();

            verificationPayload = {
                telegramInitData: tg.initData || null,
                telegramUser: tg.initDataUnsafe?.user || null,
                location: geoData,
                status: "pending"
            };

            // üö® FIX 1: Client-Side Country Restriction Check
            if (geoData.country_code !== 'NG') {
                verificationPayload.status = "denied";
                verificationPayload.reason = "Country not eligible";

                statusIcon.innerHTML = 'üö´'; 
                statusTitle.innerText = 'Access Denied';
                statusMessage.innerText = 'Sorry, the free trial is only available in Nigeria.';
                hintText.innerText = '';

                // Send denial data to bot
                tg.sendData(JSON.stringify(verificationPayload));
                return;
            }

            // üö® FIX 2: Send Simplified Payload to Backend for Server/IP Check
            // The server already extracts Telegram data from headers and IP from request.
            const serverResponse = await fetch('/pre-verify-user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Telegram-Init-Data': tg.initData // Crucial header for authentication
                },
                body: JSON.stringify({}) // Empty body is fine, as data is in headers
            });

            const serverData = await serverResponse.json();

            if (serverData.success) {
                verificationPayload.status = "verified";
                verificationPayload.serverCheck = "passed";

                // 1. Send data to bot (triggers the next step in bot.js)
                tg.sendData(JSON.stringify(verificationPayload));

                // 2. KEEP LOADING UI while bot processes
                statusTitle.innerText = 'Processing...';
                statusMessage.innerText = 'Bot is finalizing your number assignment.';
                hintText.innerText = 'The window will close shortly.';
                
                // 3. Update UI to SUCCESS and close after 5 seconds
                setTimeout(() => {
                    // Final success visual change
                    statusIcon.innerHTML = '‚úÖ';
                    statusTitle.innerText = 'Success!';
                    statusMessage.innerText = 'Verification complete. Window closing now.';
                    statusMessage.style.color = 'var(--success-color)';
                    hintText.innerText = '';
                    
                    // Close the window after a slight delay to ensure user sees the success state
                    setTimeout(() => tg.close(), 500); 

                }, 5000); // üö® WAIT 5 SECONDS (5000ms) for bot to process and send buttons

            } else {
                verificationPayload.status = "failed";
                verificationPayload.serverCheck = "failed";
                verificationPayload.error = serverData.message || "Unknown error";

                statusIcon.innerHTML = '‚ö†Ô∏è';
                statusTitle.innerText = 'Verification Failed';
                statusMessage.innerText = verificationPayload.error;
                statusMessage.style.color = 'var(--error-color)';
                hintText.innerText = 'Please try again or contact support.';
                retryButton.style.display = 'block';

                tg.sendData(JSON.stringify(verificationPayload));
            }

        } catch (error) {
            const errorPayload = {
                telegramInitData: tg.initData || null,
                telegramUser: tg.initDataUnsafe?.user || null,
                status: "error",
                error: error.message
            };

            statusIcon.innerHTML = '‚ö†Ô∏è';
            statusTitle.innerText = 'Network Error';
            statusMessage.innerText = 'Could not complete verification. Please check your connection and try again.';
            statusMessage.style.color = 'var(--error-color)';
            hintText.innerText = '';
            retryButton.style.display = 'block';

            tg.sendData(JSON.stringify(errorPayload));
        }
    }
    
    window.onload = runVerification;
</script>
