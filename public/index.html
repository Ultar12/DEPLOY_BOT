<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultar WBD</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #1c1c1e;
            color: #f1f1f1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            text-align: center;
        }

        #main-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            text-align: left;
        }
        
        #header-title {
            font-size: 1.8em;
            font-weight: 700;
            color: #fff;
            margin-bottom: 20px;
            text-align: center;
        }

        .bot-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .create-bot-card, .bot-card {
            background-color: #2c2c2e;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, background-color 0.2s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .create-bot-card:hover, .bot-card:hover {
            transform: translateY(-2px);
            background-color: #3a3a3c;
        }

        .icon-plus {
            font-size: 1.8em;
            color: #0a84ff;
            font-weight: 600;
        }

        .bot-icon-circle {
            width: 40px;
            height: 40px;
            background-color: #5856d6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            color: #fff;
        }

        .bot-details {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .bot-name {
            font-size: 1.1em;
            font-weight: 600;
        }

        .bot-username {
            font-size: 0.9em;
            color: #8e8e93;
        }

        .chevron {
            font-size: 1.5em;
            color: #8e8e93;
        }
        
        #deployment-view, #management-view {
            padding: 20px 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #f1f1f1;
        }

        .input-container {
            position: relative;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #3a3a3c;
            background-color: #2c2c2e;
            color: #fff;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: #5856d6;
        }

        .input-status-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
        }

        .status-green-border {
            border-color: #34c759;
        }

        .status-red-border {
            border-color: #ff3b30;
        }

        .status-icon-green { color: #34c759; }
        .status-icon-red { color: #ff3b30; }

        .inline-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .inline-buttons button {
            flex-grow: 1;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #3a3a3c;
            background-color: #2c2c2e;
            color: #f1f1f1;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        
        .inline-buttons button.active {
            background-color: #5856d6;
            border-color: #5856d6;
        }

        .deploy-button {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            background-color: #5856d6;
            color: #fff;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease, opacity 0.2s ease;
        }
        
        .deploy-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .glowing-button {
            animation: glowing-button 2s infinite;
        }

        @keyframes glowing-button {
            0% { box-shadow: 0 0 5px #0a84ff, 0 0 10px #0a84ff; }
            50% { box-shadow: 0 0 10px #5856d6, 0 0 20px #5856d6; }
            100% { box-shadow: 0 0 5px #0a84ff, 0 0 10px #0a84ff; }
        }

        .back-button {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #0a84ff;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .back-button .chevron-left {
            font-size: 1.2em;
        }

        .management-option {
            background-color: #2c2c2e;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: background-color 0.2s ease, transform 0.1s ease;
            cursor: pointer;
            text-align: left;
        }

        .management-option:hover {
            background-color: #3a3a3c;
            transform: translateY(-1px);
        }

        .option-label {
            font-size: 1.1em;
            font-weight: 600;
        }

        .option-info {
            font-size: 0.9em;
            color: #8e8e93;
            margin-top: 5px;
        }
        
    </style>
</head>
<body>
    <div id="main-container">
        <div id="view-container">
            </div>
    </div>

    <script>
    const API_BASE_URL = window.location.origin + '/api';
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    
    // --- State Management ---
    let deploymentState = {};
    const viewCache = {}; // Cache views to make back navigation instant

    // --- Main Render Function ---
    function renderView(viewName, data = null, isBack = false) {
        const viewContainer = document.getElementById('view-container');
        
        if (isBack && viewCache[viewName]) {
            viewContainer.innerHTML = viewCache[viewName];
            attachEventListeners(viewName); // Re-attach listeners for cached views
            return;
        }

        let newHtml = '';
        if (viewName === 'myBots') {
            newHtml = renderMyBotsView();
        } else if (viewName === 'management') {
            newHtml = renderBotManagementView(data);
        } else if (viewName === 'variables') {
            newHtml = renderVariablesView(data);
        }
        // Add other views like deployment form here if needed

        viewContainer.innerHTML = newHtml;
        viewCache[viewName] = newHtml;
        
        // Post-render logic (e.g., fetching data)
        if (viewName === 'myBots') fetchAndDisplayBots();
        if (viewName === 'variables') fetchAndDisplayVariables(data);
    }
    
    // --- View Templates ---
    function renderMyBotsView() {
        return `
            <div id="header-title">My Bots</div>
            <div class="bot-list" id="bot-list">
                <div id="bot-list-loading">Loading your bots...</div>
            </div>
        `;
    }

    function renderBotManagementView(bot) {
        return `
            <div class="back-button" onclick="renderView('myBots', null, true)">
                <span class="chevron-left">&lt;</span> Back
            </div>
            <div id="header-title">${bot.appName}</div>
            <div id="management-view">
                <div class="management-option" data-action="restart" data-app-name="${bot.appName}">
                    <div class="option-label">Restart Bot</div>
                    <div class="option-info">Restart the bot's server process if it's unresponsive.</div>
                </div>
                <div class="management-option" data-action="redeploy" data-app-name="${bot.appName}">
                    <div class="option-label">Redeploy Bot</div>
                    <div class="option-info">Update the bot to the latest version.</div>
                </div>
                <div class="management-option" data-action="variables" data-bot-json='${JSON.stringify(bot)}'>
                    <div class="option-label">Set Variables</div>
                    <div class="option-info">Edit your bot's configuration like Session ID, Prefix, etc.</div>
                </div>
                <div class="management-option" data-action="delete" data-app-name="${bot.appName}">
                    <div class="option-label">Delete Bot</div>
                    <div class="option-info">Permanently delete this bot from the server.</div>
                </div>
                 <div class="management-option" style="cursor: default;">
                    <div class="option-label">Expiration Date</div>
                    <div class="option-info" id="bot-expiration">${new Date(bot.expirationDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                </div>
            </div>
        `;
    }

    function renderVariablesView(bot) {
        return `
            <div class="back-button" onclick="renderView('management', ${JSON.stringify(bot)}, true)">
                 <span class="chevron-left">&lt;</span> Back
            </div>
            <div id="header-title">Variables</div>
            <div id="variables-list">Loading settings...</div>
        `;
    }

    // --- Data Fetching and Logic ---
    async function fetchAndDisplayBots() {
        try {
            const res = await fetch(`${API_BASE_URL}/bots`, { headers: { 'X-Telegram-Init-Data': tg.initData } });
            const data = await res.json();
            const botListEl = document.getElementById('bot-list');
            
            document.getElementById('bot-list-loading').style.display = 'none';

            if (data.success && data.bots.length > 0) {
                data.bots.forEach(bot => {
                    const card = document.createElement('div');
                    card.className = 'bot-card';
                    const botInitial = bot.appName.charAt(0).toUpperCase();
                    const statusColor = bot.status === 'Online' ? '#34c759' : '#ff3b30';
                    const expires = new Date(bot.expirationDate);
                    const daysLeft = Math.ceil((expires - new Date()) / (1000 * 60 * 60 * 24));
                    const expirationText = daysLeft > 0 ? `Expires in ${daysLeft} days` : 'Expired';

                    card.innerHTML = `
                        <div class="bot-icon-circle" style="background-color: ${statusColor};">${botInitial}</div>
                        <div class="bot-details">
                            <span class="bot-name">${bot.appName}</span>
                            <span class="bot-username">Status: ${bot.status} | ${expirationText}</span>
                        </div>
                        <div class="chevron">&gt;</div>
                    `;
                    card.onclick = () => renderView('management', bot);
                    botListEl.appendChild(card);
                });
            } else {
                botListEl.innerHTML += '<div>You have no bots deployed.</div>';
            }
        } catch (e) {
            tg.showAlert('Failed to load your bots.');
        }
    }

    async function fetchAndDisplayVariables(bot) {
        const varListEl = document.getElementById('variables-list');
        try {
            const res = await fetch(`${API_BASE_URL}/bots/config-vars/${bot.appName}`, { headers: { 'X-Telegram-Init-Data': tg.initData } });
            const data = await res.json();

            if (data.success) {
                let html = '';
                for (const [key, value] of Object.entries(data.configVars)) {
                    const displayValue = value.length > 20 ? value.substring(0, 20) + '...' : value;
                    html += `
                        <div class="management-option" onclick="editVariable('${bot.appName}', '${key}', '${value}')">
                            <div class="option-label">${key}</div>
                            <div class="option-info">${displayValue}</div>
                        </div>
                    `;
                }
                varListEl.innerHTML = html;
            } else {
                varListEl.innerHTML = `Error: ${data.message}`;
            }
        } catch (e) {
            varListEl.innerHTML = 'Failed to load bot settings.';
        }
    }

    function editVariable(appName, varName, currentValue) {
        tg.showPopup({
            title: `Edit ${varName}`,
            message: `Enter the new value for ${varName}:`,
            buttons: [
                { type: 'input', text: 'Enter value here...', placeholder: currentValue },
                { type: 'ok', text: 'Save' },
                { type: 'cancel' }
            ]
        }, async (buttonId, value) => {
            if (buttonId === 'ok' && value) {
                tg.showProgress(true);
                try {
                    const res = await fetch(`${API_BASE_URL}/bots/set-var`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Telegram-Init-Data': tg.initData },
                        body: JSON.stringify({ appName, varName, varValue: value })
                    });
                    const data = await res.json();
                    tg.hideProgress();
                    tg.showAlert(data.message);
                    if (data.success) {
                        // Refresh the variables view
                        const bot = JSON.parse(document.querySelector('[data-action="variables"]').dataset.botJson);
                        renderView('variables', bot);
                    }
                } catch (e) {
                    tg.hideProgress();
                    tg.showAlert('An error occurred.');
                }
            }
        });
    }
    
    function attachEventListeners(viewName) {
        if (viewName === 'management') {
            document.querySelectorAll('#management-view .management-option').forEach(el => {
                const action = el.dataset.action;
                if (!action) return;

                if (action === 'variables') {
                    el.onclick = () => renderView('variables', JSON.parse(el.dataset.botJson));
                } else {
                    el.onclick = () => handleBotAction(action, el.dataset.appName);
                }
            });
        }
    }
    
    // This function now handles all bot actions
    function handleBotAction(action, appName) {
        // Corrected endpoint mapping
        const endpointMap = {
            restart: 'bots/restart',
            redeploy: 'bots/redeploy',
            delete: 'bots/delete'
        };

        if (!endpointMap[action]) return;

        tg.showConfirm(`Are you sure you want to ${action} the bot "${appName}"?`, async (ok) => {
            if (!ok) return;
            tg.showProgress(true);
            try {
                const res = await fetch(`${API_BASE_URL}/${endpointMap[action]}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Telegram-Init-Data': tg.initData },
                    body: JSON.stringify({ appName })
                });
                const data = await res.json();
                tg.hideProgress();
                tg.showAlert(data.message);
                if (data.success) {
                    if (action === 'delete') {
                        renderView('myBots'); // Go back to the list immediately after deletion
                    } else {
                        setTimeout(() => renderView('myBots'), 3000); // Wait a bit after restart/redeploy
                    }
                }
            } catch (e) {
                tg.hideProgress();
                tg.showAlert('An error occurred.');
            }
        });
    }

    // Initial Load
    document.addEventListener('DOMContentLoaded', () => {
        renderView('myBots');
        // Attach a global event listener for dynamic content
        document.getElementById('view-container').addEventListener('click', (event) => {
            const target = event.target.closest('.management-option');
            if (!target || !target.dataset.action) return;

            const action = target.dataset.action;
            if (action === 'variables') {
                renderView('variables', JSON.parse(target.dataset.botJson));
            } else if (target.dataset.appName){
                handleBotAction(action, target.dataset.appName);
            }
        });
    });
</script>
    
</body>
</html>
