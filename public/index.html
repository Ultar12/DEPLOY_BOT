<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultar WBD</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #1c1c1e;
            color: #f1f1f1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            text-align: center;
        }

        #main-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            text-align: left;
        }
        
        #header-title {
            font-size: 1.8em;
            font-weight: 700;
            color: #fff;
            margin-bottom: 20px;
            text-align: center;
        }

        .bot-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .create-bot-card, .bot-card {
            background-color: #2c2c2e;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, background-color 0.2s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .create-bot-card:hover, .bot-card:hover {
            transform: translateY(-2px);
            background-color: #3a3a3c;
        }

        .icon-plus {
            font-size: 1.8em;
            color: #0a84ff;
            font-weight: 600;
        }

        .bot-icon-circle {
            width: 40px;
            height: 40px;
            background-color: #5856d6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            color: #fff;
        }

        .bot-details {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .bot-name {
            font-size: 1.1em;
            font-weight: 600;
        }

        .bot-username {
            font-size: 0.9em;
            color: #8e8e93;
        }

        .chevron {
            font-size: 1.5em;
            color: #8e8e93;
        }
        
        #deployment-view, #management-view {
            padding: 20px 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #f1f1f1;
        }

        .input-container {
            position: relative;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #3a3a3c;
            background-color: #2c2c2e;
            color: #fff;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: #5856d6;
        }

        .input-status-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
        }

        .status-green-border {
            border-color: #34c759;
        }

        .status-red-border {
            border-color: #ff3b30;
        }

        .status-icon-green { color: #34c759; }
        .status-icon-red { color: #ff3b30; }

        .inline-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .inline-buttons button {
            flex-grow: 1;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #3a3a3c;
            background-color: #2c2c2e;
            color: #f1f1f1;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        
        .inline-buttons button.active {
            background-color: #5856d6;
            border-color: #5856d6;
        }

        .deploy-button {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            background-color: #5856d6;
            color: #fff;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease, opacity 0.2s ease;
        }
        
        .deploy-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .glowing-button {
            animation: glowing-button 2s infinite;
        }

        @keyframes glowing-button {
            0% { box-shadow: 0 0 5px #0a84ff, 0 0 10px #0a84ff; }
            50% { box-shadow: 0 0 10px #5856d6, 0 0 20px #5856d6; }
            100% { box-shadow: 0 0 5px #0a84ff, 0 0 10px #0a84ff; }
        }

        .back-button {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #0a84ff;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .back-button .chevron-left {
            font-size: 1.2em;
        }

        .management-option {
            background-color: #2c2c2e;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: background-color 0.2s ease, transform 0.1s ease;
            cursor: pointer;
            text-align: left;
        }

        .management-option:hover {
            background-color: #3a3a3c;
            transform: translateY(-1px);
        }

        .option-label {
            font-size: 1.1em;
            font-weight: 600;
        }

        .option-info {
            font-size: 0.9em;
            color: #8e8e93;
            margin-top: 5px;
        }
        
    </style>
</head>
<body>
    <div id="main-container">
        <div id="view-container">
            </div>
    </div>

    
   <script>
    const API_BASE_URL = window.location.origin + '/api';
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // --- State & Cache ---
    let deploymentState = {};

    // --- Main Router / View Renderer ---
    function renderView(viewName, data = null) {
        const viewContainer = document.getElementById('view-container');
        let newHtml = '';
        switch (viewName) {
            case 'myBots': newHtml = getMyBotsViewHtml(); break;
            case 'botTypeSelection': newHtml = getBotTypeSelectionViewHtml(); break;
            case 'deploymentForm': newHtml = getDeploymentFormViewHtml(); break;
            case 'management': newHtml = getBotManagementViewHtml(data); break;
            case 'variables': newHtml = getVariablesViewHtml(data); break;
        }
        viewContainer.innerHTML = newHtml;

        if (viewName === 'myBots') fetchAndDisplayBots();
        if (viewName === 'variables') fetchAndDisplayVariables(data);
        if (viewName === 'deploymentForm') attachDeploymentFormListeners();
    }

    // --- HTML Template Functions (getMyBotsViewHtml, getBotTypeSelectionViewHtml, etc.) ---
    function getMyBotsViewHtml() {
        return `
            <div id="header-title">My Bots</div>
            <div class="bot-list" id="bot-list">
                <div class="create-bot-card" data-action="render" data-view-name="botTypeSelection">
                    <span class="icon-plus">+</span><div class="bot-details"><span class="bot-name">Create a New Bot</span></div>
                </div>
                <div id="bot-list-loading">Loading your bots...</div>
            </div>`;
    }
    function getBotTypeSelectionViewHtml() { /* ... content from previous answer ... */ return `<div class="back-button" data-action="render" data-view-name="myBots"><span class="chevron-left">&lt;</span> Back</div><div id="header-title">Select Bot Type</div><div class="inline-buttons"><button data-action="select-bot-type" data-bot-type="levanter">Levanter</button><button data-action="select-bot-type" data-bot-type="raganork">Raganork</button></div>`; }
    function getDeploymentFormViewHtml() { /* ... content from previous answer ... */ return `<div class="back-button" data-action="render" data-view-name="botTypeSelection"><span class="chevron-left">&lt;</span> Back</div><div id="header-title">New ${deploymentState.botType.charAt(0).toUpperCase()+deploymentState.botType.slice(1)} Bot</div><div id="deployment-view"><div class="form-group"><label for="appNameInput">App Name (unique, no spaces):</label><div class="input-container"><input type="text" id="appNameInput" placeholder="my-cool-bot-123"><span id="appNameStatus" class="input-status-icon"></span></div></div><div class="form-group"><label for="sessionIdInput">Session ID:</label><div class="input-container"><input type="text" id="sessionIdInput" placeholder="Paste your session ID here"><span id="sessionIdStatus" class="input-status-icon"></span></div></div><div class="form-group"><label>Auto Status View:</label><div class="inline-buttons" id="autoview-buttons"><button data-action="select-autostatus" data-value="yes">Yes</button><button data-action="select-autostatus" data-value="no" class="active">No</button></div></div><div class="form-group"><label for="deployKeyInput">Deploy Key:</label><div class="input-container"><input type="text" id="deployKeyInput" placeholder="Enter your paid deploy key"><span id="deployKeyStatus" class="input-status-icon"></span></div></div><button id="deploy-button" data-action="deploy-bot" class="deploy-button" disabled>Deploy</button></div>`; }
    function getBotManagementViewHtml(bot) { /* ... content from previous answer ... */ return `<div class="back-button" data-action="render" data-view-name="myBots"><span class="chevron-left">&lt;</span> Back</div><div id="header-title">${bot.appName}</div><div id="management-view"><div class="management-option" data-action="restart-bot" data-app-name="${bot.appName}"><div class="option-label">Restart Bot</div><div class="option-info">Restart the bot's server process.</div></div><div class="management-option" data-action="redeploy-bot" data-app-name="${bot.appName}"><div class="option-label">Redeploy Bot</div><div class="option-info">Update the bot to the latest version.</div></div><div class="management-option" data-action="render-variables" data-bot-json='${JSON.stringify(bot)}'><div class="option-label">Set Variables</div><div class="option-info">Edit your bot's configuration and settings.</div></div><div class="management-option" data-action="delete-bot" data-app-name="${bot.appName}"><div class="option-label">Delete Bot</div><div class="option-info">Permanently delete this bot.</div></div><div class="management-option" style="cursor: default;"><div class="option-label">Expiration Date</div><div class="option-info">${new Date(bot.expirationDate).toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})}</div></div></div>`; }
    function getVariablesViewHtml(bot) { /* ... content from previous answer ... */ return `<div class="back-button" data-action="render-management" data-bot-json='${JSON.stringify(bot)}'><span class="chevron-left">&lt;</span> Back</div><div id="header-title">Bot Variables</div><div id="variables-list">Loading settings...</div>`; }

    // --- Logic & Event Handlers ---
    async function fetchAndDisplayBots() { /* ... content from previous answer ... */ const botListEl=document.getElementById("bot-list");try{const e=await fetch(`${API_BASE_URL}/bots`,{headers:{"X-Telegram-Init-Data":tg.initData}}),t=await e.json();if(document.getElementById("bot-list-loading").style.display="none",t.success&&t.bots.length>0)t.bots.forEach((e=>{const t=document.createElement("div");t.className="bot-card",t.dataset.action="render-management",t.dataset.botJson=JSON.stringify(e);const a=e.appName.charAt(0).toUpperCase(),o="Online"===e.status?"#34c759":"#ff3b30",n=Math.ceil((new Date(e.expirationDate)-new Date)/(1e3*60*60*24));t.innerHTML=`\n                        <div class="bot-icon-circle" style="background-color: ${o};">${a}</div>\n                        <div class="bot-details">\n                            <span class="bot-name">${e.appName}</span>\n                            <span class="bot-username">Status: ${e.status} | ${n>0?`Expires in ${n} days`:"Expired"}</span>\n                        </div>\n                        <div class="chevron">&gt;</div>\n                    `,botListEl.appendChild(t)}));else botListEl.insertAdjacentHTML("beforeend","<div>You have no bots deployed. Create one!</div>")}catch(e){tg.showAlert("Failed to load your bots.")} }
    async function fetchAndDisplayVariables(bot) { /* ... content from previous answer ... */ const varListEl=document.getElementById("variables-list");try{const e=await fetch(`${API_BASE_URL}/bots/config-vars/${bot.appName}`,{headers:{"X-Telegram-Init-Data":tg.initData}}),t=await e.json();if(!t.success)throw new Error(t.message);let a="";for(const[o,n]of Object.entries(t.configVars)){const e=n&&n.length>20?n.substring(0,20)+"...":n;a+=`\n                        <div class="management-option" data-action="edit-variable" data-app-name="${bot.appName}" data-var-name="${o}" data-current-value="${n}">\n                            <div class="option-label">${o}</div>\n                            <div class="option-info">${e||"Not Set"}</div>\n                        </div>\n                    `}varListEl.innerHTML=a}catch(e){varListEl.innerHTML=`Error: ${e.message}`} }
    function editVariable(appName, varName, currentValue) { /* ... content from previous answer ... */ const booleanVars=["ALWAYS_ONLINE","AUTO_READ_STATUS","AUTO_STATUS_VIEW","ANTI_DELETE"];booleanVars.includes(varName)?tg.showPopup({title:`Set ${varName}`,message:"Choose an option:",buttons:[{id:"enable",type:"default",text:"✅ Enable"},{id:"disable",type:"default",text:"🚫 Disable"},{type:"cancel"}]},(e=>{("enable"===e||"disable"===e)&&updateVariableOnServer(appName,varName,"enable"===e)})):tg.showPopup({title:`Edit ${varName}`,message:"Enter the new value:",buttons:[{id:"input",type:"input",placeholder:currentValue||"Enter value"},{id:"ok",type:"ok"},{type:"cancel"}]},((e,t)=>{ "ok"===e&&t&&updateVariableOnServer(appName,varName,t)}))}
    async function updateVariableOnServer(appName, varName, varValue) { /* ... content from previous answer ... */ tg.showProgress(!0);try{const e=await fetch(`${API_BASE_URL}/bots/set-var`,{method:"POST",headers:{"Content-Type":"application/json","X-Telegram-Init-Data":tg.initData},body:JSON.stringify({appName,varName,varValue})}),t=await e.json();tg.hideProgress(),tg.showAlert(t.message),t.success&&renderView("variables",JSON.parse(document.querySelector('[data-action="render-variables"]').dataset.botJson))}catch(e){tg.hideProgress(),tg.showAlert("An error occurred while updating the variable.")}}
    function attachDeploymentFormListeners() { /* ... content from previous answer ... */ deploymentState.autoStatusView="no",["appNameInput","sessionIdInput","deployKeyInput"].forEach((e=>{document.getElementById(e).addEventListener("input",checkAllInputs)}))}
    async function checkAllInputs() { /* ... content from previous answer ... */ const e=document.getElementById("deploy-button"),t=document.getElementById("appNameInput").value.length>2,a=document.getElementById("sessionIdInput").value.length>9,o=document.getElementById("deployKeyInput").value.length>4;e.disabled=!(t&&a&&o),e.disabled?e.classList.remove("glowing-button"):e.classList.add("glowing-button")}
    async function handleDeploy() { /* ... content from previous answer ... */ tg.showProgress("Deploying...");const e={botType:deploymentState.botType,appName:document.getElementById("appNameInput").value.trim(),sessionId:document.getElementById("sessionIdInput").value.trim(),autoStatusView:deploymentState.autoStatusView,deployKey:document.getElementById("deployKeyInput").value.trim()};try{const t=await fetch(`${API_BASE_URL}/deploy`,{method:"POST",headers:{"Content-Type":"application/json","X-Telegram-Init-Data":tg.initData},body:JSON.stringify(e)}),a=await t.json();tg.hideProgress(),tg.showAlert(a.message),a.success&&renderView("myBots")}catch(e){tg.hideProgress(),tg.showAlert("Failed to initiate deployment.")}}
    
    // ❗️ THIS IS THE UPDATED FUNCTION ❗️
    async function handleBotAction(action, appName) {
        const endpointMap = {
            'restart-bot': 'bots/restart',
            'redeploy-bot': 'bots/redeploy',
            'delete-bot': 'bots/delete'
        };
        const verb = action.split('-')[0];
        
        tg.showConfirm(`Are you sure you want to ${verb} the bot "${appName}"?`, async (ok) => {
            if (!ok) return;

            const button = document.querySelector(`[data-action='${action}'][data-app-name='${appName}']`);
            const label = button ? button.querySelector('.option-label') : null;
            const originalText = label ? label.textContent : '';

            // --- New UX for Restart ---
            if (action === 'restart-bot' && label) {
                label.textContent = '🔄 Restarting...';
                button.style.pointerEvents = 'none';
                button.style.opacity = '0.6';

                try {
                    const res = await fetch(`${API_BASE_URL}/${endpointMap[action]}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Telegram-Init-Data': tg.initData },
                        body: JSON.stringify({ appName })
                    });
                    const data = await res.json();
                    if (!data.success) throw new Error(data.message);
                    
                    await new Promise(resolve => setTimeout(resolve, 3000)); // Wait 3 seconds
                    label.textContent = '✅ Restarted!';

                } catch (e) {
                    label.textContent = '❌ Failed';
                    tg.showAlert(e.message || 'An error occurred during restart.');
                } finally {
                    setTimeout(() => { // Revert button to original state
                        if(label) label.textContent = originalText;
                        if(button) {
                            button.style.pointerEvents = 'auto';
                            button.style.opacity = '1';
                        }
                    }, 2000);
                }
            } else {
                // --- Original UX for Redeploy & Delete ---
                tg.showProgress(true);
                try {
                    const res = await fetch(`${API_BASE_URL}/${endpointMap[action]}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Telegram-Init-Data': tg.initData },
                        body: JSON.stringify({ appName })
                    });
                    const data = await res.json();
                    tg.hideProgress();
                    tg.showAlert(data.message);
                    if (data.success) {
                         setTimeout(() => renderView('myBots'), action === 'delete-bot' ? 500 : 3000);
                    }
                } catch (e) {
                    tg.hideProgress();
                    tg.showAlert('An error occurred.');
                }
            }
        });
    }

    // --- Central Event Listener ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('view-container').addEventListener('click', (event) => {
            const target = event.target.closest('[data-action]');
            if (!target) return;
            const { action, viewName, botJson, appName, varName, currentValue, botType, value } = target.dataset;
            switch (action) {
                case 'render': renderView(viewName); break;
                case 'render-management': renderView('management', JSON.parse(botJson)); break;
                case 'render-variables': renderView('variables', JSON.parse(botJson)); break;
                case 'restart-bot':
                case 'redeploy-bot':
                case 'delete-bot':
                    handleBotAction(action, appName); break;
                case 'edit-variable': editVariable(appName, varName, currentValue); break;
                case 'select-bot-type': deploymentState.botType = botType; renderView('deploymentForm'); break;
                case 'select-autostatus':
                    deploymentState.autoStatusView = value;
                    document.querySelectorAll('#autoview-buttons button').forEach(btn => btn.classList.remove('active'));
                    target.classList.add('active');
                    checkAllInputs(); break;
                case 'deploy-bot': handleDeploy(); break;
            }
        });
        renderView('myBots');
    });
</script>
     
    
</body>
</html>
